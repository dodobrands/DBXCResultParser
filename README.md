# Peekie

[![](https://img.shields.io/endpoint?url=https%3A%2F%2Fswiftpackageindex.com%2Fapi%2Fpackages%2Fdodobrands%2FDBXCResultParser%2Fbadge%3Ftype%3Dswift-versions)](https://swiftpackageindex.com/dodobrands/DBXCResultParser)
[![](https://img.shields.io/endpoint?url=https%3A%2F%2Fswiftpackageindex.com%2Fapi%2Fpackages%2Fdodobrands%2FDBXCResultParser%2Fbadge%3Ftype%3Dplatforms)](https://swiftpackageindex.com/dodobrands/DBXCResultParser)
[![](https://github.com/dodobrands/DBXCResultParser/actions/workflows/unittest.yml/badge.svg)](https://github.com/dodobrands/DBXCResultParser/actions/workflows/unittest.yml)
[![](https://img.shields.io/badge/XCTest-Supported-success)](https://developer.apple.com/documentation/xctest)
[![](https://img.shields.io/badge/Swift%20Testing-Supported-success)](https://www.swift.org/documentation/package-manager/)

The `PeekieSDK` package provides a Swift module for parsing `.xcresult` files generated by Xcode to produce a structured report of build and test results. It supports both **XCTest** and **Swift Testing** frameworks, and works with the modern `.xcresult` format (without requiring the `--legacy` flag). It allows developers to programmatically access detailed information about test cases, code coverage, and warnings from their CI/CD pipelines or automated scripts.

## Table of Contents

- [Features](#features)
- [Installation](#installation)
- [Usage](#usage)
  - [Parsing xcresult Files](#parsing-xcresult-files)
  - [Formatters](#formatters)
    - [TextFormatter](#textformatter)
    - [SonarFormatter](#sonarformatter)
  - [Command-Line Tool](#command-line-tool)
- [License](#license)

## Features

- Supports **XCTest** and **Swift Testing** frameworks.
- Parses modern `.xcresult` format (uses `xcresulttool` without `--legacy` flag).
- Parses `.xcresult` files to create a typed model of the test results and code coverage.
- Filters out coverage data related to test helpers and test cases.
- Provides a detailed breakdown of modules, files, and repeatable tests.
- Extracts build warnings from `.xcresult` files (Swift Compiler Warnings only).
- Calculates total and average test durations, as well as combined test statuses.
- Supports identifying slow tests based on average duration.
- Includes utility functions for filtering tests based on status.
- Can be executed as a command-line tool to generate test reports directly from the terminal.
- **SonarQube integration**: Generates SonarQube Generic Test Execution XML format for CI/CD integration.

## Installation

To use `PeekieSDK` in your Swift package, add it to the dependencies for your `Package.swift` file:

```swift
let package = Package(
    name: "YourPackageName",
    dependencies: [
        .package(url: "https://github.com/dodobrands/DBXCResultParser", .upToNextMajor(from: "3.0.0"))
    ],
    targets: [
        .target(
            name: "YourTargetName",
            dependencies: ["PeekieSDK"]
        )
    ]
)
```

## Usage

### Parsing xcresult Files

To parse an `.xcresult` file and access the report data, initialize a `Report` with the path to the `.xcresult` file:

```swift
import PeekieSDK

let xcresultPath = URL(fileURLWithPath: "/path/to/your.xcresult")
let reportModel = try await Report(xcresultPath: xcresultPath)

// Access different parts of the report:
let modules = reportModel.modules
let coverage = reportModel.coverage // Coverage value from 0.0 to 1.0
let warnings = reportModel.warnings // Array of build warnings

// Access warnings:
for warning in warnings {
    print("Warning: \(warning.message)")
    print("  Location: \(warning.sourceURL)")
    print("  Class: \(warning.className)")
}

// Iterate over modules, files, and tests:
for module in modules {
    print("Module: \(module.name)")
    for file in module.files {
        print("  File: \(file.name)")
        for repeatableTest in file.repeatableTests {
            print("    Repeatable Test: \(repeatableTest.name)")
            for test in repeatableTest.tests {
                print("      Test: \(test.status.icon) - Duration: \(test.duration)")
            }
        }
    }
}
```

### Formatters

The `PeekieSDK` package provides multiple formatters to convert parsed `.xcresult` data into different output formats. Each formatter is designed for specific use cases:

- **TextFormatter**: Generates human-readable text output for terminal display and logs
- **SonarFormatter**: Generates SonarQube Generic Test Execution XML format for CI/CD integration

### TextFormatter

The `TextFormatter` class provides a way to format the data from a `Report` into a human-readable string. It supports two output formats: a detailed list of test results and a summary count of test results.

#### Usage

To format your test report data, create an instance of `TextFormatter`:

```swift
import PeekieSDK

// Assuming you have already created a `Report` instance as `reportModel`
let reportModel: Report = ...

// Create a text formatter
let formatter = TextFormatter()

// Format the report data into a string
let formattedOutput = formatter.format(reportModel)

// Print the formatted output
print("Formatted Output:\n\(formattedOutput)")
```

The `format` method can also take an array of `Report.Module.File.RepeatableTest.Test.Status` to filter which test results are included in the output. By default, it includes all test statuses.

**Filtering by status:**

```swift
// Only show failures
let failuresOnly = formatter.format(reportModel, include: [.failure])

// Show both failures and skipped tests
let failuresAndSkipped = formatter.format(reportModel, include: [.failure, .skipped])

// Show only successful tests
let successesOnly = formatter.format(reportModel, include: [.success])
```

**Using count format:**

```swift
// Get summary count instead of detailed list
let summary = formatter.format(reportModel, format: .count)
// Output: "12 tests (1m 23s)"

// Count only failures
let failureCount = formatter.format(reportModel, include: [.failure], format: .count)
// Output: "3 tests (45s)"
```

#### Output Formats

##### List Format

Outputs a detailed list of test results, including the name of each file and the status of each test.

**Basic Test Statuses:**
- `‚úÖ` - Success
- `‚ùå` - Failure
- `‚è≠Ô∏è` - Skipped
- `ü§°` - Expected Failure
- `‚ö†Ô∏è` - Mixed (flaky test with different results across retries)
- `ü§∑` - Unknown

**Example output:**

```
FileA.swift
‚úÖ test_success()
‚ùå test_failure() (Failure message)
‚è≠Ô∏è test_skip() (Skip message)
ü§° test_expectedFailure() (Failure is expected)
‚ö†Ô∏è test_flacky() (Flacky failure message)

FileB.swift
‚úÖ test_success()
```

**Parameterized Tests (Swift Testing):**
Each argument from parameterized tests is displayed as a separate test line with its own status:

```
FakeSUITests
‚úÖ success()
‚ùå failure() (GenerateXCResultTests.swift:56: Issue recorded: Failure message)
‚è≠Ô∏è disabled() (Test 'disabled()' skipped: Disabled reason)
ü§° expectedFailure()
‚ö†Ô∏è flacky() (GenerateXCResultTests.swift:75: Issue recorded: Flacky failure message)
‚úÖ flackyParameterized(value:) (true)
‚ùå flackyParameterized(value:) (false)
‚úÖ somethingWithWarning()
```

##### Count Format

Outputs a summary count of test results, including the total number of tests and their combined duration.

```
12 tests (1m 23s)
```

When filtering by status (e.g., only failures), duration is omitted if only skipped tests are included:

```
5 tests
```

#### Customizing Number and Measurement Formatting

The `TextFormatter` allows you to specify a locale when formatting the report. This locale is used to format numbers and measurements according to the provided locale's conventions.

```swift
let formatter = TextFormatter()
let output = formatter.format(reportModel, locale: Locale(identifier: "fr_FR"))
print(output) // Will output numbers and durations formatted in French
```

### SonarFormatter

The `SonarFormatter` class generates test execution reports in SonarQube Generic Test Execution XML format. This format is compatible with SonarQube's test execution import feature, allowing you to visualize test results directly in SonarQube.

**Use cases:**
- CI/CD pipeline integration with SonarQube
- Automated test reporting in SonarQube dashboards
- Test execution tracking and analysis

#### Usage

To generate a SonarQube-compatible XML report programmatically:

```swift
import PeekieSDK

// Assuming you have already created a `Report` instance as `reportModel`
let reportModel: Report = ...

// Path to the directory containing your test source files (not the .xcresult file)
// This directory should contain your test .swift source files
let testsPath = URL(fileURLWithPath: "/path/to/your/tests")

// Create a Sonar formatter
let formatter = SonarFormatter()

// Generate the XML report
let xmlReport = try formatter.format(report: reportModel, testsPath: testsPath)

// Print or save the XML report
print(xmlReport)
```

#### Features

- **Parameterized Tests Support**: Each parameterized test execution is represented as a separate `<testCase>` entry with parameters included in the test name (e.g., `testName (paramValue)`).
- **File Grouping**: Test cases from multiple test suites (classes/structs) within the same file are automatically grouped into a single `<file>` section.
- **Test Status Mapping**: Maps test statuses to SonarQube format:
  - Success: `<testCase>` without failure/skipped elements
  - Failure: `<testCase>` with `<failure>` element
  - Skipped: `<testCase>` with `<skipped>` element
- **Duration Reporting**: Test execution durations are reported in milliseconds.

#### XML Output Format

The formatter generates XML in the following structure:

```xml
<testExecutions version="1">
    <file path="path/to/TestFile.swift">
        <testCase name="test_success()" duration="1234" />
        <testCase name="test_failure()" duration="567">
            <failure message="Failure message" />
        </testCase>
        <testCase name="test_skip()" duration="0">
            <skipped message="Skip message" />
        </testCase>
        <testCase name="test_parameterized(value:) (param1)" duration="890" />
        <testCase name="test_parameterized(value:) (param2)" duration="901" />
    </file>
</testExecutions>
```

### Command-Line Tool

The package includes a command-line tool that can be executed to generate test reports. The tool supports two subcommands: `text` for human-readable text output and `sonar` for SonarQube XML format.

#### Text Format Subcommand

```bash
swift run peekie text --xcresult-path path/to/tests.xcresult
```

**Examples:**

```bash
# Default: list format with all test statuses
swift run peekie text --xcresult-path path/to/tests.xcresult

# Count format (summary)
swift run peekie text --xcresult-path path/to/tests.xcresult --format count

# Show only failures
swift run peekie text --xcresult-path path/to/tests.xcresult --include failure

# Show failures and skipped tests
swift run peekie text --xcresult-path path/to/tests.xcresult --include failure,skipped

# Use specific locale for formatting
swift run peekie text --xcresult-path path/to/tests.xcresult --locale ru-RU

# Combine options: count format with only failures, using French locale
swift run peekie text --xcresult-path path/to/tests.xcresult --format count --include failure --locale fr-FR
```

**Available options for `text` subcommand:**
- `--xcresult-path`: Specifies the path to the `.xcresult` file (required).
- `--format`: Determines the output format (`list` or `count`). Default: `list`.
- `--locale`: Sets the locale for number and measurement formatting (e.g., "en-GB", "ru-RU", "fr-FR"). Default: system locale.
- `--include`: Filters the test results to include only certain statuses. Comma-separated list of: `success`, `failure`, `skipped`, `expectedFailure`, `mixed`, `unknown`. Default: all statuses.

#### SonarQube Format Subcommand

```bash
swift run peekie sonar --xcresult-path path/to/tests.xcresult --tests-path path/to/tests
```

**Examples:**

```bash
# Generate SonarQube XML report
# Note: --tests-path must point to a directory containing test source files, not the .xcresult file
swift run peekie sonar --xcresult-path path/to/tests.xcresult --tests-path path/to/tests

# Save output to file
swift run peekie sonar --xcresult-path path/to/tests.xcresult --tests-path Tests/PeekieTests > sonar-report.xml
```

**Available options for `sonar` subcommand:**
- `--xcresult-path`: Specifies the path to the `.xcresult` file (required).
- `--tests-path`: Specifies the path to the directory containing test source files (required). This must be a directory path (not a `.xcresult` file) containing your test source code (`.swift` files). This is used to map test suite names to file paths.

## License

This code is released under the Apache License. See [LICENSE](LICENSE) for more information.
